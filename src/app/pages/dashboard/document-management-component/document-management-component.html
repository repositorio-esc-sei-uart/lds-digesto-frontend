<div class="management-container">

  <div class="header">
    @if (isAdmin) {
    <h1>Registro de Documentos</h1>
    } @else {
    <h1>Gestión de Documentos</h1>
    }
    @if (!isAdmin) {
    <a mat-flat-button color="primary" (click)="openNewDocumentDialog()">
      <mat-icon>add</mat-icon>
      <span>Nuevo Documento</span>
    </a>
    }
  </div>

  <mat-form-field appearance="outline" class="filter-field">
    <mat-label>Filtrar documentos...</mat-label>
    <input matInput (keyup)="applyFilter($event)" placeholder="Ej: RES-2024-101...">
    <mat-icon matSuffix>search</mat-icon>
  </mat-form-field>

  @if (isLoading) {
  <div class="loading-shade">
    <mat-spinner></mat-spinner>
  </div>
  }

  <div [hidden]="isLoading">

    @if (isAdmin) {
    <div class="mat-elevation-z4 table-container">
      <h3>Registro de Auditoría</h3>
      <table mat-table [dataSource]="dataSourceAuditoria" class="user-table" matSort>

        <ng-container matColumnDef="numDocumento">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> N° Documento </th>
          <td mat-cell *matCellDef="let reg"> {{ reg.numDocumento }} </td>
        </ng-container>

        <ng-container matColumnDef="titulo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Título </th>
          <td mat-cell *matCellDef="let reg" class="truncate-cell" [matTooltip]="reg.tituloDocumento">
            {{ reg.tituloDocumento }}
          </td>
        </ng-container>

        <ng-container matColumnDef="autor">
          <th mat-header-cell *matHeaderCellDef> Autor </th>
          <td mat-cell *matCellDef="let reg"> {{ reg.nombreUsuario }} </td>
        </ng-container>

        <ng-container matColumnDef="fechaCarga">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha de Carga </th>
          <td mat-cell *matCellDef="let reg"> {{ reg.fechaCarga | date:'dd/MM/yyyy' }} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsAuditoria; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsAuditoria;"></tr>

        @if (!isLoading && dataSourceAuditoria.data.length === 0) {
        <tr class="mat-row-no-data">
          <td class="mat-cell" [attr.colspan]="displayedColumnsAuditoria.length">
            No se encontraron registros de auditoría.
          </td>
        </tr>
        }
      </table>
    </div>
    }

    @else {
    <div class="mat-elevation-z4 table-container">
      <table mat-table [dataSource]="dataSourceGestion" [hidden]="isLoading" matSort>

        <ng-container matColumnDef="numDocumento">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> N° Documento </th>
          <td mat-cell *matCellDef="let doc"> {{ doc.numDocumento }} </td>
        </ng-container>

        <ng-container matColumnDef="titulo">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Título </th>
          <td mat-cell *matCellDef="let doc" class="truncate-cell" [matTooltip]="doc.titulo">
            {{ doc.titulo }}
          </td>
        </ng-container>

        <ng-container matColumnDef="tipoDocumento">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Tipo </th>
          <td mat-cell *matCellDef="let doc"> {{ doc.tipoDocumento.nombre }} </td>
        </ng-container>

        <ng-container matColumnDef="fechaCreacion">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Fecha </th>
          <td mat-cell *matCellDef="let doc"> {{ doc.fechaCreacion | date:'dd/MM/yyyy' }} </td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Estado </th>
          <td mat-cell *matCellDef="let doc">
            <span class="status-chip" [ngClass]="getStatusClass(doc.estado.nombre)">
              {{ doc.estado.nombre }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef class="col-acciones-header"> Acciones </th>
          <td mat-cell *matCellDef="let doc" class="col-acciones">
            <button mat-icon-button (click)="openPreviewModal(doc.idDocumento)" matTooltip="Previsualizar (Modal)">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button (click)="onEdit(doc)" color="primary" matTooltip="Editar Documento">
              <mat-icon>edit</mat-icon>
            </button>
            @if (doc.activo) {
            <button mat-icon-button color="warn" matTooltip="Dar de baja" (click)="toggleEstadoDocumento(doc)">
              <mat-icon>delete_outline</mat-icon>
            </button>
            } @else {
            <button mat-icon-button class="btn-restaurar" matTooltip="Reactivar documento"
              (click)="toggleEstadoDocumento(doc)">
              <mat-icon>restore_from_trash</mat-icon>
            </button>
            }
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsGestion; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsGestion;" [class.inactivo]="!row.activo">
        </tr>

        @if (!isLoading && dataSourceGestion.data.length === 0) {
        <tr class="mat-row-no-data">
          <td class="mat-cell" [attr.colspan]="displayedColumnsGestion.length">
            No se encontraron documentos para mostrar.
          </td>
        </tr>
        }
      </table>
    </div>
    }
  </div>
</div>
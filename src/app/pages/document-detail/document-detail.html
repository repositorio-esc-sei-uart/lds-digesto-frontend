<!--
  Se define la plantilla para la vista de detalle de un documento.
  Se utiliza el nuevo control de flujo '@if' para renderizar condicionalmente el contenido.
-->

<!-- @if (documento) Bloque que se muestra si el documento se encuentra. -->
@if (documento) {
@if (!isDialog) {
<!-- Sección de Acciones: Botón 'Volver'. -->
<div class="page-actions">
  <a mat-stroked-button routerLink="/home">
    <mat-icon>arrow_back</mat-icon>
    <span>Volver al inicio</span>
  </a>
</div>
}

<!-- Contenedor Principal en Grilla -->
<div class="detail-container" [class.modal-padding]="isDialog">

  <!-- Columna Izquierda: Contenido Principal -->
  <div class="document-content">
    <!-- Card Principal con Resumen -->
    <mat-card>
      <mat-card-header>
        <mat-card-title>{{ documento.titulo }}</mat-card-title>
        <mat-card-subtitle>{{ documento.numDocumento }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <h3 class="summary-title">Resumen</h3>
        <p class="document-body">{{ documento.resumen }}</p>
      </mat-card-content>
    </mat-card>

    <!-- Card de Archivos Adjuntos -->
    @if (documento.archivos && documento.archivos.length > 0) {
    <mat-card class="section-card">
      <mat-card-content>
        <h3><mat-icon>attach_file</mat-icon> Archivos Adjuntos</h3>
        <div class="file-list">
          @for (archivo of documento.archivos; track archivo.idArchivo) {
          <a [href]="archivo.url" target="_blank" class="file-item">
            <mat-icon>picture_as_pdf</mat-icon>
            <span>{{ archivo.nombre }}</span>
          </a>
          }
        </div>
      </mat-card-content>
    </mat-card>
    }

    <!-- Card de Documentos Relacionados (Referencias) -->
    @if (documento.referencias && documento.referencias.length > 0) {
    <mat-card class="section-card">
      <mat-card-content>
        <h3><mat-icon>link</mat-icon> Este documento hace referencia a:</h3>
        <div class="references-list">
          @for (ref of documento.referencias; track ref.idDocumento) {
          <a class="reference-item"
            [routerLink]="(isDialog || (!ref.activo && !canViewInactive)) ? null : ['/documento', ref.idDocumento]"
            [class.disabled-link]="!ref.activo && !canViewInactive"
            (click)="(!ref.activo && !canViewInactive) ? $event.preventDefault() : onReferenceClick($event, ref.idDocumento)"
            [style.cursor]="(!ref.activo && !canViewInactive) ? 'default' : 'pointer'"
            [matTooltip]="!ref.activo ? (canViewInactive ? 'Ver documento (Inactivo)' : 'Documento dado de baja') : 'Ver documento'">
            <mat-icon>article</mat-icon>
            <span>{{ ref.numDocumento }}</span>
            @if (!ref.activo) {
            <small style="font-size: 0.7em; margin-left: 4px; color: red;">
              {{ canViewInactive ? '(Inactivo)' : '(No Disponible)' }}
            </small>
            }
          </a>
          }
        </div>
      </mat-card-content>
    </mat-card>
    }

    <!-- Card de Documentos Relacionados (Referenciado Por) -->
    @if (documento.referenciadoPor && documento.referenciadoPor.length > 0) {
    <mat-card class="section-card">
      <mat-card-content>
        <h3><mat-icon>link</mat-icon> Este documento es referenciado por:</h3>
        <div class="references-list">
          @for (ref of documento.referenciadoPor; track ref.idDocumento) {
          <a class="reference-item"
            [routerLink]="(isDialog || (!ref.activo && !canViewInactive)) ? null : ['/documento', ref.idDocumento]"
            [class.disabled-link]="!ref.activo && !canViewInactive"
            (click)="(!ref.activo && !canViewInactive) ? $event.preventDefault() : onReferenceClick($event, ref.idDocumento)"
            [style.cursor]="(!ref.activo && !canViewInactive) ? 'default' : 'pointer'"
            [matTooltip]="!ref.activo ? (canViewInactive ? 'Ver documento (Inactivo)' : 'Documento dado de baja') : 'Ver documento'">

            <mat-icon>article</mat-icon>
            <span>{{ ref.numDocumento }}</span>

            @if (!ref.activo) {
            <small style="font-size: 0.7em; margin-left: 4px; color: red;">
              {{ canViewInactive ? '(Inactivo)' : '(No Disponible)' }}
            </small>
            }
          </a>
          }
        </div>
      </mat-card-content>
    </mat-card>
    }
  </div>

  <!-- Columna Derecha: Barra Lateral con Metadatos -->
  <div class="document-sidebar">
    <!-- Card de Detalles -->
    <mat-card>
      <mat-card-content>
        <h3>Detalles del Documento</h3>
        <!-- Metadatos (Estado, Tipo, Sector, Fecha) -->
        <div class="metadata-item">
          <mat-icon>label_important</mat-icon>
          <div class="metadata-text">
            <span>Estado</span>
            <strong [ngClass]="'status-' + documento.estado.nombre.split(' ')[0]">{{ documento.estado.nombre }}</strong>
          </div>
        </div>
        <div class="metadata-item">
          <mat-icon>assignment</mat-icon>
          <div class="metadata-text">
            <span>Tipo</span>
            <strong>{{ documento.tipoDocumento.nombre }}</strong>
          </div>
        </div>
        <div class="metadata-item">
          <mat-icon>corporate_fare</mat-icon>
          <div class="metadata-text">
            <span>Sector Emisor</span>
            <strong>{{ documento.sector.nombre }}</strong>
          </div>
        </div>
        <div class="metadata-item">
          <mat-icon>calendar_today</mat-icon>
          <div class="metadata-text">
            <span>Fecha de Creación</span>
            <strong>{{ documento.fechaCreacion | date:'dd/MM/yyyy' }}</strong>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Card de Palabras Clave -->
    @if (documento.palabrasClave && documento.palabrasClave.length > 0) {
    <mat-card class="section-card">
      <mat-card-content>
        <h3><mat-icon>sell</mat-icon> Palabras Clave</h3>
        <div class="keywords-container">
          @for (keyword of documento.palabrasClave; track keyword.idPalabraClave) {
          <span class="keyword-chip">{{ keyword.nombre }}</span>
          }
        </div>
      </mat-card-content>
    </mat-card>
    }
  </div>
</div>
<!-- Bloque que se muestra si el documento NO se encuentra. -->
@if (isDialog) {
<div style="padding: 1rem; text-align: right;">
  <button mat-stroked-button (click)="cerrarModal()">Cerrar Vista</button>
</div>
}

} @else {
<div class="not-found-container">
  <mat-icon>search_off</mat-icon>
  <h2>Documento no Encontrado</h2>
  @if (!isDialog) {
  <a mat-stroked-button routerLink="/home">Volver al inicio</a>
  } @else {
  <button mat-stroked-button (click)="cerrarModal()">Cerrar</button>
  }
</div>
}